pipeline {
	agent any
	
	stages {
		stage('Build') {
			steps {
				script {
                    bat 'msbuild WebApp.csproj /restore /p:Configuration=Release %MSBUILD_ARGS%'
                }
			}
		}
		stage('Publish') {
			steps {
				script {
                    bat 'dotnet publish -c Release -o ./publish'
                }
			}
		}
		stage('Deploy') {
			steps {
				echo 'Deploying...'
				withCredentials([sshUserPrivateKey(credentialsId: 'nvanhecke', keyFileVariable : 'SSH_KEY')]) {
					 echo 'In Key part'
					 ssh nvanhecke@4.211.249.95 'powershell.exe -Command Stop-Website "Default Web site"
					 echo '%SSH_KEY%'
                     bat 'scp.exe -r ./publish/* nvanhecke@4.211.249.95:/inetpub/wwwroot'
					 ssh nvanhecke@4.211.249.95 'powershell.exe -Command Start-Website "Default Web site"
                }
               
			}
		}	
	 }
}